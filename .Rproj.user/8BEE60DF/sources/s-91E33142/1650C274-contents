---
title: "Demo HR-SIP"
output: html_notebook
---

Demo of HR-SIP (High Resolution Stable Isotope Probing)
from qiime data on run one

# Scripts for Sequence Analysis 
```{r, eval=F}
## QC

#!/bin/bash
#SBATCH --partition=compute
#SBATCH --ntasks=1
#SBATCH --mem=10gb
#SBATCH --time=04:35:00

module load anaconda3/2021.05
source activate bbtools

cd  /vortexfs1/home/olivia.ahern/trophic_cascades/raw_data/
for sample in $(cat samples); \
do echo "On sample: $sample";
bbduk.sh in1="$sample"_R1_001.fastq out1=../filtered3/"$sample"_R1_filt.fq \
in2="$sample"_R2_001.fastq out2=../filtered3/"$sample"_R2_filt.fq \
literal=CACGACGCTCTTCCGATCTGTGYCAGCMGCCGCGGTAA,GACGTGTGCTCTTCCGATCTGGACTACNVGGGTWTCTAAT \
k=18 ordered=t mink=11 ktrim=l rcomp=t tbo tpe \
hdist=1 minavgquality=25 \
ref=/vortexfs1/omics/huber/db/adapters/illumina-adapters.fa
done 2> bbduk_primer_trimming_stats2.txt


## Qiime2

#!/bin/bash
#SBATCH --partition=compute
#SBATCH --ntasks=1
#SBATCH --mem=40gb
#SBATCH --cpus-per-task=20
#SBATCH --time=04:35:00
 
module load anaconda/5.1
source activate qiime2-2018.8
echo importing 
 
qiime tools import \
--type 'SampleData[PairedEndSequencesWithQuality]' \
--input-path manifest.txt \
--output-path /vortexfs1/scratch/olivia.ahern/21Oct21/tagseq-qiime2-snakemake/paired-end-demux.qza \
--input-format PairedEndFastqManifestPhred33
echo made a sequence file from your manifest 
 
echo running dada2 
qiime dada2 denoise-paired \
    --i-demultiplexed-seqs paired-end-demux.qza \
    --p-n-threads 20 \
    --p-trunc-q 2 \
    --p-trunc-len-f 200 \
    --p-trunc-len-r 200 \
    --p-max-ee 2 \
    --p-n-reads-learn 1000000 \
    --p-chimera-method pooled \
    --o-table ASVs/asv_table.qza \
    --o-representative-sequences ASVs/rep-seqs.qza \
    --o-denoising-stats ASVs/stats-dada2.qza
echo classifying sequences
qiime feature-classifier classify-sklearn --i-classifier silva_all.qza \
	 --i-reads ASVs/rep-seqs.qza \
	 --o-classification ASVs/asv_tax_sklearn.qza
 
cd ASVs
qiime tools export --input-path asv_table.qza \
	--output-path asv_table
 
biom convert -i asv_table/feature-table.biom -o asv_table/asv-table.tsv --to-tsv
 
qiime tools export  --input-path asv_tax_sklearn.qza --output-path asv_tax_dir

```

# HR-SIP
Link to demo:
https://cran.r-project.org/web/packages/HTSSIP/vignettes/MW_HR_SIP.html

```{r}
library(HTSSIP)
library(phyloseq)
library(ggplot2)
library(ape)
# load data in 
x<-read.csv(file='/Users/ahern/R/trophic_cascades/mc2/26oct21/ASV_run3/asv_table.csv',header=TRUE,row.names=1)
dim(x)
OTU = otu_table(x, taxa_are_rows=T)
taxa<-read.csv(file="/Users/ahern/R/trophic_cascades/mc2/26oct21/ASV_run3/taxonomy.csv",header=TRUE,row.names=1)
t<-as.matrix(taxa)
tax2<-tax_table(t)
map<-import_qiime_sample_data("/Users/ahern/R/trophic_cascades/mc2/26oct21/ASV_run3/map.txt")
tree=read.tree("/Users/ahern/R/trophic_cascades/mc2/26oct21/ASV_run3/tree.nwk")

phyo = phyloseq(OTU, tax2,map,tree)
phyo
```
species number
```{r}
otu=t(otu_table(phyo))
library(vegan)
s=specnumber(otu)


{par(mar=c(5,5,1,1))
mp=barplot(s,horiz=F,las=2,beside=F,cex.names =0.5,
        col='gray30', xaxt='n',ylim=c(0,400),
        ylab="No. of ASVs")
box(which='plot')
mtext(text = row.names(otu), side = 1, at = mp, line = 0.2,las=2,cex=0.7)
}
```

```{r}
data<-read.csv("/Users/ahern/R/trophic_cascades/mc2/26oct21/ASV_run3/bd_data.csv",header=T,row.names=1)

summary(data$TP)
MC5=data[1:10,]
MC9=data[11:23,]
MC11=data[24:32,]
MC12=data[33:41,]
MC14=data[42:51,]
MC15=data[52:60,]
library(viridis)
col=viridis(6)

{plot(MC5$BD,MC5$R_MAX,type='o', xlim=c(1.731,1.819),pch=21,
      bg=col[1])
lines(MC9$BD,MC9$R_MAX,type='o',add=T,pch=21,
      bg=col[2])
lines(MC11$BD,MC11$R_MAX,type='o',add=T,pch=21,
      bg=col[3])
lines(MC12$BD,MC12$R_MAX,type='o',add=T,pch=21,
      bg=col[4])
lines(MC14$BD,MC14$R_MAX,type='o',add=T,pch=21,
      bg=col[5])
lines(MC15$BD,MC15$R_MAX,type='o',add=T,pch=21,
      bg=col[6])
}
```


## DESEQ TRANSFORMATION 
```{r}
ddst=phyloseq_to_deseq2(phyo,~Treatment)
gm_mean = function(x, na.rm=TRUE){
exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x))
1
}
trial.deseq=estimateSizeFactors(ddst,geoMeans = apply(counts(ddst), 1, gm_mean))
data.vst <- DESeq2::varianceStabilizingTransformation(trial.deseq, blind = T)
# Apply variance stabilizing transformation
# Extract transformed OTU table
fieldEco.vstMat <- assay(data.vst)
# And put into my phloseq object
OTU = otu_table(fieldEco.vstMat, taxa_are_rows=T)
mcp_vst=phyloseq(OTU,map,tax2,tree)


dist=distance(mcp_vst,'euclidean')
p=prcomp(dist)
plot(p$x[,1],p$x[,2], pch = sample_data(mcp_vst)$pch,
     bg=sample_data(mcp_vst)$col,
     xlab= 'PCA1 65%', ylab='PCoA2 19%')
# remove siders

mcp_vst2=subset_samples(mcp_vst,ID != "SidersPond")
mcp_vst2

dist=distance(mcp_vst2,'euclidean')
p=prcomp(dist)
plot(p$x[,1],p$x[,2], pch = sample_data(mcp_vst2)$pch,
     bg=sample_data(mcp_vst2)$col,
     xlab= 'PCoA1 41%', ylab='PCoA2 26%')


dist=UniFrac(mcp_vst2,weighted=T)
p=prcomp(dist)
plot(p$x[,1],p$x[,2], pch = sample_data(mcp_vst2)$pch,
     bg=sample_data(mcp_vst2)$col,
     xlab= 'PCoA1 41%', ylab='PCoA2 26%')
```

```{r}

phyo_c=subset_samples(phyo,ID != "SidersPond")
phyo_c
trans=transform_sample_counts(phyo_c, function(x) log(x+1))

dist=UniFrac(trans,weighted=T)
p=prcomp(dist)
plot(p$x[,1],p$x[,2], pch = sample_data(trans)$pch,
     bg=sample_data(trans)$col,
     xlab= 'PCoA1 68%', ylab='PCoA2 16%')
ordiellipse(p, groups=sample_data(trans)$Treatment,label=T)

otu=t(otu_table(phyo_c))
log=log(otu+1)
dist=vegdist(log,'bray',na.rm=T)
meta=metaMDS(dist)
pch2=c('22','22','22','22','22','22','22','22','22','21','21','21','21','21','21','21','21','21')
{ordiplot(meta,type='none')
points(meta,bg=as.character(sample_data(phyo_c)$col),pch=as.numeric(sample_data(phyo_c)$pch),cex=2,lwd=1)
ordiellipse(meta, groups=sample_data(trans)$Treatment,label=T)
legend('topleft',legend=c('11MC2-Comm','12MC2-Comm','14MC2-Comm','15MC2-Comm','5MC2-Comm','6MC2-Comm','7MC2-Comm','8MC2-Comm','9MC2-Comm','11MC2-Frac','12MC2-Frac','14MC2-Frac','15MC2-Frac','5MC2-Frac','6MC2-Frac','7MC2-Frac','8MC2-Frac','9MC2-Frac'),
       pt.bg=c('#ba4758','#b75136','#c18a3c','#9fac3a','#69a150','#45c097','#6881d8','#8650a6','#b74d86'),
       ncol=2,bty='n', pch=21) }


{ordiplot(meta,type='none',yaxt='n',xaxt='n')
points(meta,bg=as.character(sample_data(phyo_c)$col),pch=as.numeric(sample_data(phyo_c)$pch),cex=2,lwd=1)
ordiellipse(meta, groups=sample_data(trans)$Frac,label=T)}


```

```{r}
phyo_f=subset_samples(phyo_c,Comm_Frac=="Frac")
phyo_f
trans=transform_sample_counts(phyo_f, function(x) log(x+1))

otu=t(otu_table(phyo_f))
spec=specnumber(otu)
plot(sample_data(trans)$BD, spec, bg=sample_data(trans)$col, pch =21,cex=2)

dist=UniFrac(trans,weighted=T)
p=prcomp(dist)
plot(p$x[,1],p$x[,2], pch = sample_data(trans)$pch,
     bg=sample_data(trans)$col,
     xlab= 'PCoA1 67%', ylab='PCoA2 16%')
ordiellipse(p, groups=sample_data(trans)$Treatment,label=T)

dist=UniFrac(trans,weighted=T)
p=prcomp(dist)
plot(p$x[,1],p$x[,2], pch = sample_data(trans)$pch,
     bg=sample_data(trans)$col,
     xlab= 'PCoA1 67%', ylab='PCoA2 16%')
ordiellipse(p, groups=sample_data(trans)$Frac,label=T)

plot(sample_data(trans)$BD, p$x[,1], bg=sample_data(trans)$col, pch =21,cex=2)

```



```{r}
phyo_f=subset_samples(phyo_c,Comm_Frac=="Frac")
phyo_f
## try divide by ratio of maximum
rmax=sample_data(phyo_f)$R_MAX
otu=t(otu_table(phyo_f))

otu_t=(otu*rmax)
lala=t(otu_t)

trans_16s=phyloseq(t(otu_t),map,tax2,tree)
trans_16s

dist=UniFrac(trans_16s,weighted=T)
p=prcomp(dist)
plot(p$x[,1],p$x[,2], pch = sample_data(trans)$pch,
     bg=sample_data(trans)$col,
     xlab= 'PCoA1 67%', ylab='PCoA2 16%')
ordiellipse(p, groups=sample_data(trans)$Treatment,label=T)

otu=t(otu_table(trans_16s))
bray=vegdist(otu,'bray')
meta=metaMDS(bray)
{ordiplot(meta,type='none')
points(meta,bg=as.character(sample_data(phyo_c)$col),pch=as.numeric(sample_data(phyo_c)$pch),cex=2,lwd=1)
ordiellipse(meta, groups=sample_data(trans)$Treatment,label=T)
legend('topleft',legend=c('11MC2-Comm','12MC2-Comm','14MC2-Comm','15MC2-Comm','5MC2-Comm','6MC2-Comm','7MC2-Comm','8MC2-Comm','9MC2-Comm','11MC2-Frac','12MC2-Frac','14MC2-Frac','15MC2-Frac','5MC2-Frac','6MC2-Frac','7MC2-Frac','8MC2-Frac','9MC2-Frac'),
       pt.bg=c('#ba4758','#b75136','#c18a3c','#9fac3a','#69a150','#45c097','#6881d8','#8650a6','#b74d86'),
       ncol=2,bty='n', pch=21) }

```
# heavy sip 
https://cran.r-project.org/web/packages/HTSSIP/vignettes/heavy_SIP.html
```{r}

phyo_f=subset_samples(phyo, Treatment=="15MC2" | Treatment=="5MC2")
phyo_h=subset_samples(phyo_f, Comm_Frac=="Frac")
phyo_h
# range BD for MC5 = 1.746,1.813
# range BD for MC15 = 1.739,1.795

df_res=heavy_SIP(phyo_h, ex="Treatment=='5MC2'", light_window = c(1.746,1.813),
          heavy_window = c(1.739,1.795), comparison="H-v-L", hypo_test = 'wilcox')
df_res=heavy_SIP(phyo_h, ex="Treatment=='5MC2'", comparison="H-v-L", hypo_test = 'wilcox')

bd1=BD_shift(phyo_h, ex="Treatment=='5MC2'", perm_method='control')

ggplot(bd1, aes(BD_min.x, wmean_dist)) +
   geom_point()
```